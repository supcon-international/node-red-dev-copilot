<!-- Dev Copilot èŠ‚ç‚¹é…ç½®é¢æ¿ -->
<script type="text/javascript">
  RED.nodes.registerType("dev-copilot", {
    category: "ai",
    color: "#87CEEB",
    defaults: {
      name: { value: "" },
      provider: { value: "openai", required: true },
      model: { value: "gpt-4", required: true },
      mcpCommand: { value: "" },
      mcpArgs: { value: "" },
      mcpEnv: { value: "" },
      systemPrompt: { value: "You are a helpful development assistant." },
    },
    credentials: {
      apiKey: { type: "password", required: true },
    },
    inputs: 1,
    outputs: 1,
    icon: "font-awesome/fa-robot",
    label: function () {
      return this.name || `${this.provider} ${this.model}`;
    },
    labelStyle: function () {
      return this.name ? "node_label_italic" : "";
    },
    paletteLabel: "dev copilot",
    oneditprepare: function () {
      const providerPlaceholders = {
        openai: "ä¾‹å¦‚: gpt-4, gpt-4-turbo, gpt-3.5-turbo, gpt-4o, gpt-4o-mini",
        anthropic:
          "ä¾‹å¦‚: claude-3-5-sonnet-20241022, claude-3-opus-20240229, claude-3-haiku-20240307",
        google: "ä¾‹å¦‚: gemini-1.5-pro, gemini-1.5-flash, gemini-pro",
        deepseek: "ä¾‹å¦‚: deepseek-chat, deepseek-reasoner",
      };

      function updateModelPlaceholder() {
        const provider = $("#node-input-provider").val();
        const modelInput = $("#node-input-model");

        if (providerPlaceholders[provider]) {
          modelInput.attr("placeholder", providerPlaceholders[provider]);
        }
      }

      // æä¾›å•†æ”¹å˜æ—¶æ›´æ–°æ¨¡å‹placeholder
      $("#node-input-provider").on("change", function () {
        updateModelPlaceholder();
      });

      // åˆå§‹åŒ–
      updateModelPlaceholder();
    },
  });
</script>

<!-- èŠ‚ç‚¹ç¼–è¾‘é¢æ¿æ¨¡æ¿ -->
<script type="text/html" data-template-name="dev-copilot">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>

  <div class="form-row">
    <label for="node-input-provider"
      ><i class="fa fa-cloud"></i> Provider</label
    >
    <select id="node-input-provider">
      <option value="openai">OpenAI</option>
      <option value="anthropic">Anthropic</option>
      <option value="google">Google</option>
      <option value="deepseek">DeepSeek</option>
    </select>
  </div>

  <div class="form-row">
    <label for="node-input-model"><i class="fa fa-cog"></i> Model</label>
    <input
      type="text"
      id="node-input-model"
      placeholder="ä¾‹å¦‚: gpt-4, gpt-4-turbo, gpt-3.5-turbo, gpt-4o, gpt-4o-mini"
    />
    <div class="form-tips">
      è¾“å…¥æ‚¨è¦ä½¿ç”¨çš„æ¨¡å‹åç§°ï¼Œä¼šæ ¹æ®Provideræ˜¾ç¤ºæ¨èæ¨¡å‹
    </div>
  </div>

  <div class="form-row">
    <label for="node-input-apiKey"><i class="fa fa-key"></i> API Key</label>
    <input type="password" id="node-input-apiKey" data-nr-credentials="true" />
  </div>

  <div class="form-row">
    <label for="node-input-mcpCommand"
      ><i class="fa fa-terminal"></i> MCP Command</label
    >
    <input
      type="text"
      id="node-input-mcpCommand"
      placeholder="ä¾‹å¦‚: npx @modelcontextprotocol/server-everything æˆ– python server.py"
    />
    <div class="form-tips">MCP æœåŠ¡å™¨å¯åŠ¨å‘½ä»¤ï¼ˆç•™ç©ºè¡¨ç¤ºä¸ä½¿ç”¨ MCPï¼‰</div>
  </div>

  <div class="form-row">
    <label for="node-input-mcpArgs"><i class="fa fa-list"></i> Arguments</label>
    <input
      type="text"
      id="node-input-mcpArgs"
      placeholder="ä¾‹å¦‚: --port 3000 --verbose"
    />
    <div class="form-tips">å¯é€‰ï¼šå‘½ä»¤è¡Œå‚æ•°ï¼Œç”¨ç©ºæ ¼åˆ†éš”</div>
  </div>

  <div class="form-row">
    <label for="node-input-mcpEnv"
      ><i class="fa fa-gear"></i> Environment Variables</label
    >
    <input
      type="text"
      id="node-input-mcpEnv"
      placeholder="ä¾‹å¦‚: API_KEY=xxx,DEBUG=true"
    />
    <div class="form-tips">
      å¯é€‰ï¼šç¯å¢ƒå˜é‡ï¼Œæ ¼å¼ä¸º KEY=valueï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”
    </div>
  </div>

  <div class="form-row">
    <label for="node-input-systemPrompt"
      ><i class="fa fa-comment"></i> System Prompt</label
    >
    <textarea
      id="node-input-systemPrompt"
      rows="4"
      placeholder="You are a helpful development assistant."
    ></textarea>
  </div>
</script>

<!-- èŠ‚ç‚¹å¸®åŠ©æ–‡æ¡£ -->
<script type="text/html" data-help-name="dev-copilot">
  <p>AI Development Copilot node with MCP (Model Context Protocol) support.</p>

  <h3>Configuration</h3>
  <dl class="message-properties">
    <dt>Provider <span class="property-type">string</span></dt>
    <dd>The AI provider to use (OpenAI, Anthropic, Google, DeepSeek)</dd>

    <dt>Model <span class="property-type">string</span></dt>
    <dd>
      The specific model to use (e.g., gpt-4, claude-3-5-sonnet-20241022,
      gemini-1.5-pro)
    </dd>

    <dt>API Key <span class="property-type">credentials</span></dt>
    <dd>API key for the selected provider</dd>

    <dt>MCP Server Path <span class="property-type">string</span></dt>
    <dd>Path to the MCP server executable (optional)</dd>

    <dt>MCP Server Args <span class="property-type">string</span></dt>
    <dd>Arguments to pass to the MCP server (optional)</dd>

    <dt>System Prompt <span class="property-type">string</span></dt>
    <dd>System prompt to use for AI interactions</dd>
  </dl>

  <h3>Input</h3>
  <dl class="message-properties">
    <dt>payload <span class="property-type">string | object</span></dt>
    <dd>The user message or query to send to the AI</dd>

    <dt>history <span class="property-type">array</span></dt>
    <dd>Optional conversation history array</dd>
  </dl>

  <h3>Output</h3>
  <dl class="message-properties">
    <dt>payload <span class="property-type">string</span></dt>
    <dd>The AI's response</dd>

    <dt>llm_config <span class="property-type">object</span></dt>
    <dd>Configuration used for this request</dd>

    <dt>mcp_available <span class="property-type">boolean</span></dt>
    <dd>Whether MCP tools are available</dd>

    <dt>mcp_tools <span class="property-type">array</span></dt>
    <dd>Available MCP tools (if MCP is connected)</dd>
  </dl>

  <h3>Details</h3>
  <p>
    This node provides AI assistance for development tasks. It can optionally
    connect to MCP (Model Context Protocol) servers to extend functionality with
    additional tools and resources.
  </p>

  <p>
    The node also registers a sidebar interface for interactive chat
    functionality.
  </p>
</script>

<!-- ä¾§è¾¹æ æ³¨å†Œè„šæœ¬ -->
<script type="text/javascript">
  (function () {
    let sidebarRegistered = false;

    function registerDevCopilotSidebar() {
      if (sidebarRegistered) {
        console.log("Dev Copilot sidebar already registered");
        return;
      }

      try {
        // æ£€æŸ¥ RED å¯¹è±¡æ˜¯å¦å¯ç”¨
        if (!RED || !RED.sidebar) {
          console.log("RED.sidebar not available yet, will retry...");
          setTimeout(registerDevCopilotSidebar, 500);
          return;
        }

        // æ³¨å†Œä¾§è¾¹æ æ ‡ç­¾
        RED.sidebar.addTab({
          id: "dev-copilot-sidebar",
          label: "Dev Copilot",
          name: "Dev Copilot",
          iconClass: "fa fa-robot",
          content: $('<div id="dev-copilot-content"></div>'),
          toolbar: $('<div id="dev-copilot-toolbar"></div>'),
          enableOnEdit: true,
          onchange: function () {
            loadSidebarContent();
          },
        });

        sidebarRegistered = true;
        console.log("Dev Copilot sidebar registered successfully");

        // ç«‹å³åŠ è½½å†…å®¹
        loadSidebarContent();
      } catch (error) {
        console.error("Failed to register Dev Copilot sidebar:", error);
        // å¦‚æœå¤±è´¥ï¼Œç¨åé‡è¯•
        setTimeout(registerDevCopilotSidebar, 1000);
      }
    }

    // ç­‰å¾… DOM å’Œ RED å®Œå…¨åŠ è½½
    $(document).ready(function () {
      // å»¶è¿Ÿæ³¨å†Œä»¥ç¡®ä¿ RED å®Œå…¨åŠ è½½
      setTimeout(registerDevCopilotSidebar, 100);
    });

    // ç›‘å¬è¿è¡Œæ—¶äº‹ä»¶ä½œä¸ºå¤‡ç”¨
    if (RED && RED.events) {
      RED.events.on("runtime-event", function (event) {
        if (
          event.id === "runtime-state" &&
          event.payload.state === "start" &&
          !sidebarRegistered
        ) {
          registerDevCopilotSidebar();
        }
      });
    }

    function loadSidebarContent() {
      const content = $("#dev-copilot-content");
      if (content.length === 0) {
        console.log("Dev Copilot content div not found, will retry...");
        setTimeout(loadSidebarContent, 500);
        return;
      }

      console.log("Loading Dev Copilot sidebar content...");

      // åŠ è½½ä¾§è¾¹æ å†…å®¹
      $.get("/dev-copilot/sidebar")
        .done(function (data) {
          console.log("Dev Copilot sidebar content loaded successfully");
          content.html(data);
          initializeSidebarFunctionality();
        })
        .fail(function (xhr, status, error) {
          console.error("Failed to load Dev Copilot sidebar:", {
            status: xhr.status,
            statusText: xhr.statusText,
            error: error,
          });

          let errorMsg = "Failed to load Dev Copilot sidebar";
          if (xhr.status) {
            errorMsg += " (HTTP " + xhr.status + ")";
          }
          if (error) {
            errorMsg += ": " + error;
          }

          content.html(
            '<div class="red-ui-info-outline"><p>' +
              errorMsg +
              "</p><p>Check browser console for more details.</p></div>"
          );
        });
    }

    function initializeSidebarFunctionality() {
      // åˆå§‹åŒ–ä¾§è¾¹æ åŠŸèƒ½
      const messageContainer = $("#dev-copilot-messages");
      const messageInput = $("#dev-copilot-input");
      const sendButton = $("#dev-copilot-send");
      const configButton = $("#dev-copilot-config");
      const nodeSelect = $("#dev-copilot-node-select");

      // æ¶ˆæ¯å†å²
      let messageHistory = [];
      let currentNodeId = null;

      // åŠ è½½å¯ç”¨èŠ‚ç‚¹
      loadAvailableNodes();

      // å‘é€æ¶ˆæ¯
      function sendMessage() {
        const message = messageInput.val().trim();
        if (!message) {
          addMessageToUI("error", "è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹");
          return;
        }

        // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†èŠ‚ç‚¹
        if (!currentNodeId) {
          addMessageToUI(
            "error",
            "è¯·å…ˆé€‰æ‹©ä¸€ä¸ªDev CopilotèŠ‚ç‚¹ã€‚å¦‚æœæ²¡æœ‰å¯ç”¨èŠ‚ç‚¹ï¼Œè¯·å…ˆåœ¨ç”»å¸ƒä¸­åˆ›å»ºå’Œé…ç½®èŠ‚ç‚¹ã€‚"
          );
          return;
        }

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
        addMessageToUI("user", message);
        messageHistory.push({ role: "user", content: message });

        // æ¸…ç©ºè¾“å…¥æ¡†
        messageInput.val("");

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        addMessageToUI("assistant", "æ­£åœ¨æ€è€ƒ...", true);

        // å‘é€è¯·æ±‚
        $.ajax({
          url: "/dev-copilot/chat",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            message: message,
            nodeId: currentNodeId,
            history: messageHistory.slice(-10), // ä¿ç•™æœ€è¿‘10æ¡æ¶ˆæ¯
          }),
          success: function (response) {
            // ç§»é™¤åŠ è½½æ¶ˆæ¯
            $(".dev-copilot-loading").remove();

            if (response.success) {
              addMessageToUI("assistant", response.response);
              messageHistory.push({
                role: "assistant",
                content: response.response,
              });
            } else {
              addMessageToUI("error", "é”™è¯¯: " + response.error);
            }
          },
          error: function (xhr) {
            $(".dev-copilot-loading").remove();

            let errorMsg = "ç½‘ç»œé”™è¯¯";
            try {
              const errorResponse = JSON.parse(xhr.responseText);
              errorMsg = errorResponse.error || errorMsg;
            } catch (e) {
              errorMsg = xhr.responseText || errorMsg;
            }

            addMessageToUI("error", errorMsg);
          },
        });
      }

      // æ·»åŠ æ¶ˆæ¯åˆ°UI
      function addMessageToUI(type, content, isLoading = false) {
        const messageDiv = $(
          '<div class="dev-copilot-message dev-copilot-' + type + '"></div>'
        );
        if (isLoading) {
          messageDiv.addClass("dev-copilot-loading");
        }

        // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®æ ·å¼å’Œå¤„ç†å†…å®¹
        if (type === "info") {
          messageDiv.css({
            "background-color": "#e3f2fd",
            "border-left": "4px solid #2196f3",
            padding: "12px",
            margin: "8px 0",
            "border-radius": "4px",
            "white-space": "pre-line",
            "font-size": "14px",
            "line-height": "1.4",
          });
        } else if (type === "warning") {
          messageDiv.css({
            "background-color": "#fff3e0",
            "border-left": "4px solid #ff9800",
            padding: "12px",
            margin: "8px 0",
            "border-radius": "4px",
            "white-space": "pre-line",
            "font-size": "14px",
            "line-height": "1.4",
            color: "#e65100",
          });
        } else if (type === "error") {
          messageDiv.css({
            "background-color": "#ffebee",
            "border-left": "4px solid #f44336",
            padding: "12px",
            margin: "8px 0",
            "border-radius": "4px",
            "white-space": "pre-line",
            color: "#c62828",
          });
        } else if (type === "user") {
          messageDiv.css({
            "background-color": "#f0f0f0",
            padding: "8px 12px",
            margin: "4px 0",
            "border-radius": "8px",
            "text-align": "right",
            "margin-left": "20%",
          });
        } else if (type === "assistant") {
          messageDiv.css({
            "background-color": "#e8f5e8",
            padding: "8px 12px",
            margin: "4px 0",
            "border-radius": "8px",
            "margin-right": "20%",
            "white-space": "pre-line",
          });
        }

        messageDiv.text(content);
        messageContainer.append(messageDiv);
        messageContainer.scrollTop(messageContainer[0].scrollHeight);
      }

      // åŠ è½½å¯ç”¨èŠ‚ç‚¹
      function loadAvailableNodes() {
        $.get("/dev-copilot/nodes", function (nodes) {
          console.log("ğŸ” åŠ è½½èŠ‚ç‚¹åˆ—è¡¨:", nodes);
          nodeSelect.empty();

          // åˆ†ç¦»å·²éƒ¨ç½²å’Œæœªéƒ¨ç½²çš„èŠ‚ç‚¹
          const deployedNodes = nodes.filter(
            (node) => node.status === "deployed"
          );
          const undeployedNodes = nodes.filter(
            (node) => node.status === "not_deployed"
          );

          console.log(
            `ğŸ“Š èŠ‚ç‚¹çŠ¶æ€ç»Ÿè®¡: æ€»è®¡ ${nodes.length}, å·²éƒ¨ç½² ${deployedNodes.length}, æœªéƒ¨ç½² ${undeployedNodes.length}`
          );

          if (deployedNodes.length === 0) {
            if (nodes.length === 0) {
              // å®Œå…¨æ²¡æœ‰èŠ‚ç‚¹
              nodeSelect.append(
                '<option value="">æ²¡æœ‰å¯ç”¨çš„èŠ‚ç‚¹ - è¯·å…ˆåˆ›å»ºå’Œéƒ¨ç½²</option>'
              );

              addMessageToUI(
                "info",
                `
ğŸš€ æ¬¢è¿ä½¿ç”¨ Dev Copilotï¼

è¦å¼€å§‹ä½¿ç”¨ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

1ï¸âƒ£ **åˆ›å»ºèŠ‚ç‚¹**: ä»å·¦ä¾§é¢æ¿çš„ "ai" åˆ†ç±»ä¸­æ‹–æ‹½ "dev copilot" èŠ‚ç‚¹åˆ°ç”»å¸ƒ

2ï¸âƒ£ **é…ç½®èŠ‚ç‚¹**: åŒå‡»èŠ‚ç‚¹ï¼Œé…ç½®ä»¥ä¸‹ä¿¡æ¯ï¼š
   â€¢ é€‰æ‹© LLM æä¾›å•† (OpenAI/Anthropic/Google)
   â€¢ è¾“å…¥å¯¹åº”çš„ API å¯†é’¥
   â€¢ é€‰æ‹©è¦ä½¿ç”¨çš„æ¨¡å‹
   â€¢ (å¯é€‰) é…ç½® MCP æœåŠ¡å™¨

3ï¸âƒ£ **éƒ¨ç½²**: ç‚¹å‡»å³ä¸Šè§’çº¢è‰²çš„ "éƒ¨ç½²" æŒ‰é’®

4ï¸âƒ£ **é€‰æ‹©èŠ‚ç‚¹**: åœ¨ä¸Šæ–¹ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©å·²éƒ¨ç½²çš„èŠ‚ç‚¹

ç„¶åå°±å¯ä»¥å¼€å§‹ä¸ AI åŠ©æ‰‹å¯¹è¯äº†ï¼ ğŸ‰
              `
              );
            } else {
              // æœ‰èŠ‚ç‚¹ä½†éƒ½æœªéƒ¨ç½²
              nodeSelect.append(
                '<option value="">æ‰€æœ‰èŠ‚ç‚¹éƒ½æœªéƒ¨ç½² - è¯·ç‚¹å‡»éƒ¨ç½²æŒ‰é’®</option>'
              );

              addMessageToUI(
                "warning",
                `
âš ï¸ å‘ç° ${undeployedNodes.length} ä¸ªæœªéƒ¨ç½²çš„èŠ‚ç‚¹

å·²åˆ›å»ºçš„èŠ‚ç‚¹ï¼š
${undeployedNodes
  .map((n) => `â€¢ ${n.name} (${n.provider} ${n.model})`)
  .join("\n")}

ğŸ”§ è¦ä½¿ç”¨è¿™äº›èŠ‚ç‚¹ï¼Œè¯·ï¼š
1ï¸âƒ£ æ£€æŸ¥èŠ‚ç‚¹é…ç½®æ˜¯å¦å®Œæ•´ï¼ˆåŒå‡»èŠ‚ç‚¹æŸ¥çœ‹ï¼‰
2ï¸âƒ£ ç‚¹å‡»å³ä¸Šè§’çº¢è‰²çš„ "éƒ¨ç½²" æŒ‰é’®
3ï¸âƒ£ ç­‰å¾…éƒ¨ç½²å®Œæˆååˆ·æ–°é¡µé¢
4ï¸âƒ£ é‡æ–°é€‰æ‹©èŠ‚ç‚¹

ğŸ’¡ å¦‚æœéƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ä¿¡æ¯å’ŒAPIå¯†é’¥é…ç½®ã€‚
              `
              );
            }
          } else {
            // æœ‰å·²éƒ¨ç½²çš„èŠ‚ç‚¹
            nodeSelect.append(
              '<option value="">è¯·é€‰æ‹©ä¸€ä¸ª Dev Copilot èŠ‚ç‚¹...</option>'
            );

            // æ·»åŠ å·²éƒ¨ç½²çš„èŠ‚ç‚¹
            deployedNodes.forEach(function (node) {
              const displayName = node.name || "æœªå‘½åèŠ‚ç‚¹";
              const option = $("<option></option>")
                .val(node.id)
                .text(`${displayName} (${node.provider} ${node.model})`);
              nodeSelect.append(option);
            });

            // å¦‚æœæœ‰æœªéƒ¨ç½²çš„èŠ‚ç‚¹ï¼Œæ˜¾ç¤ºåˆ†éš”ç¬¦å’Œæé†’
            if (undeployedNodes.length > 0) {
              nodeSelect.append(
                `<option disabled>--- æœªéƒ¨ç½²çš„èŠ‚ç‚¹ (${undeployedNodes.length}ä¸ª) ---</option>`
              );
              undeployedNodes.forEach(function (node) {
                const displayName = node.name || "æœªå‘½åèŠ‚ç‚¹";
                const option = $("<option></option>")
                  .val("")
                  .attr("disabled", true)
                  .text(
                    `âŒ ${displayName} (${node.provider} ${node.model}) - éœ€è¦éƒ¨ç½²`
                  );
                nodeSelect.append(option);
              });
            }

            // è‡ªåŠ¨é€‰æ‹©é€»è¾‘
            if (deployedNodes.length === 1) {
              nodeSelect.val(deployedNodes[0].id);
              currentNodeId = deployedNodes[0].id;

              let warningMsg = "";
              if (undeployedNodes.length > 0) {
                warningMsg = `\n\nâš ï¸ æ³¨æ„ï¼šè¿˜æœ‰ ${undeployedNodes.length} ä¸ªèŠ‚ç‚¹æœªéƒ¨ç½²ã€‚å¦‚éœ€ä½¿ç”¨ï¼Œè¯·éƒ¨ç½²ååˆ·æ–°é¡µé¢ã€‚`;
              }

              addMessageToUI(
                "info",
                `
âœ… å·²è‡ªåŠ¨é€‰æ‹©èŠ‚ç‚¹: ${deployedNodes[0].name || "æœªå‘½åèŠ‚ç‚¹"} (${
                  deployedNodes[0].provider
                } ${deployedNodes[0].model})

ç°åœ¨å¯ä»¥å¼€å§‹å¯¹è¯äº†ï¼ä½ å¯ä»¥è¯¢é—®ï¼š
â€¢ ğŸ“ ä»£ç ç¼–å†™å’Œä¼˜åŒ–å»ºè®®
â€¢ ğŸ› è°ƒè¯•å’Œé—®é¢˜è§£å†³  
â€¢ ğŸ“š æŠ€æœ¯æ–‡æ¡£å’Œæœ€ä½³å®è·µ
â€¢ ğŸ”§ Node-RED æµç¨‹å¼€å‘å¸®åŠ©

${
  deployedNodes[0].provider === "openai"
    ? "ğŸ’¡ æç¤ºï¼šä½ æ­£åœ¨ä½¿ç”¨ OpenAIï¼Œæ”¯æŒå¼ºå¤§çš„ä»£ç ç”Ÿæˆå’Œåˆ†æèƒ½åŠ›ï¼"
    : ""
}
${
  deployedNodes[0].provider === "anthropic"
    ? "ğŸ’¡ æç¤ºï¼šä½ æ­£åœ¨ä½¿ç”¨ Anthropic Claudeï¼Œæ“…é•¿è¯¦ç»†çš„åˆ†æå’Œè§£é‡Šï¼"
    : ""
}${warningMsg}
              `
              );
            } else if (deployedNodes.length > 1) {
              addMessageToUI(
                "info",
                `
ğŸ“‹ å‘ç° ${deployedNodes.length} ä¸ªå¯ç”¨èŠ‚ç‚¹ï¼Œè¯·åœ¨ä¸Šæ–¹ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ä¸€ä¸ªå¼€å§‹å¯¹è¯ã€‚

${
  undeployedNodes.length > 0
    ? `âš ï¸ å¦æœ‰ ${undeployedNodes.length} ä¸ªèŠ‚ç‚¹æœªéƒ¨ç½²ï¼Œå¦‚éœ€ä½¿ç”¨è¯·å…ˆéƒ¨ç½²ã€‚`
    : ""
}
              `
              );
            }
          }
        }).fail(function (xhr, status, error) {
          console.error("âŒ åŠ è½½èŠ‚ç‚¹å¤±è´¥:", { xhr, status, error });
          nodeSelect.empty();
          nodeSelect.append('<option value="">åŠ è½½èŠ‚ç‚¹å¤±è´¥</option>');
          addMessageToUI(
            "error",
            `æ— æ³•åŠ è½½å¯ç”¨èŠ‚ç‚¹ï¼Œè¯·æ£€æŸ¥ Node-RED è¿æ¥çŠ¶æ€ã€‚
          
é”™è¯¯è¯¦æƒ…ï¼š${error || "Unknown error"}
çŠ¶æ€ç ï¼š${xhr.status || "N/A"}`
          );
        });
      }

      // äº‹ä»¶ç›‘å¬
      sendButton.on("click", sendMessage);
      messageInput.on("keypress", function (e) {
        if (e.which === 13 && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      nodeSelect.on("change", function () {
        currentNodeId = $(this).val();
        messageHistory = []; // åˆ‡æ¢èŠ‚ç‚¹æ—¶æ¸…ç©ºå†å²
        messageContainer.empty(); // æ¸…ç©ºæ¶ˆæ¯æ˜¾ç¤º
      });

      configButton.on("click", function () {
        RED.notify(
          "Use the node configuration panel to modify settings",
          "info"
        );
      });
    }
  })();
</script>
